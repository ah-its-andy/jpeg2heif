name: png-to-avif
description: "Convert PNG to AVIF format with high quality settings"
runs-on: shell
timeout: 180

can_convert:
  extensions: [".png"]

env:
  QUALITY: "{{QUALITY}}"
  SPEED: "4"

steps:
  - name: convert-to-avif
    run: |
      avifenc --min 0 --max 63 --speed {{SPEED}} --jobs 4 \
        "{{INPUT_FILE}}" "{{TMP_OUTPUT}}"
    workdir: "{{TMP_DIR}}"
    timeout: 120

  - name: verify-output
    run: |
      echo "Verifying output file..."
      file "{{TMP_OUTPUT}}"
      ls -lh "{{TMP_OUTPUT}}"
    timeout: 10

  - name: calculate-compression-ratio
    run: |
      ORIG_SIZE=$(stat -f%z "{{INPUT_FILE}}" 2>/dev/null || stat -c%s "{{INPUT_FILE}}")
      NEW_SIZE=$(stat -f%z "{{TMP_OUTPUT}}" 2>/dev/null || stat -c%s "{{TMP_OUTPUT}}")
      echo "Original: $ORIG_SIZE bytes"
      echo "Compressed: $NEW_SIZE bytes"
      echo "Ratio: $(echo "scale=2; ($ORIG_SIZE - $NEW_SIZE) * 100 / $ORIG_SIZE" | bc)%"
    timeout: 10

outputs:
  output_file: "{{TMP_OUTPUT}}"
